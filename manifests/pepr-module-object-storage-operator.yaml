apiVersion: v1
kind: Namespace
metadata:
  name: pepr-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pepr-object-storage-operator
rules:
  - apiGroups:
      - '*'
    resources:
      - '*'
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pepr-object-storage-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: pepr-object-storage-operator
subjects:
  - kind: ServiceAccount
    name: pepr-object-storage-operator
    namespace: pepr-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pepr-object-storage-operator
  namespace: pepr-system
---
apiVersion: v1
kind: Secret
metadata:
  name: pepr-object-storage-operator-api-token
  namespace: pepr-system
type: Opaque
data:
  value: >-
    ZWYzN2RmNDYxMGFiOTE5MTliZTIxZWY0OTg5YWNiNzRkMjUwMGYzMzRmYTg5YWFlZjlkZTA1OGQ5YzhlYWJkZQ==
---
apiVersion: v1
kind: Secret
metadata:
  name: pepr-object-storage-operator-tls
  namespace: pepr-system
type: kubernetes.io/tls
data:
  tls.crt: >-
    LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tDQpNSUlDdGpDQ0FaNmdBd0lCQWdJQkFUQU5CZ2txaGtpRzl3MEJBUXNGQURBQU1CNFhEVEkwTURFeU5USXhOVE16DQpOMW9YRFRJMU1ERXlOVEl4TlRNek4xb3dBRENDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DDQpnZ0VCQUpZQ3g2RlpTeGxYa0ltNXhUY0JidURXSjBoaTZ1clBlczNSOE90Z2grNnVlTHU2bzFRdkFkNERTOGxpDQp6Q1pJd2w3MTVzN1U2NEpaMzBEQk9RTG5mOE9HSkx0T2dUemU0SXVlOFpwdlN4VlVja2pVRTREMWtvMjFKUGFjDQp3T204Q3BXRk14YVhTclJsT2R4enVNS0Z2RWh6cGhsNXpLVnVIWnJrWXhORERQN1hhYVNkVzRWaERZWWoyN0drDQpieG9zOVVQcTN5U2ZqN1NiY3dhTERUVFBoM3lSd2hwTFE3NzdTdm5OdW5rMlFHNVB1TkpkNzhKVlhjWHJmRXcvDQpkOU9wOXBHU0ZIdVdDUkZ0VWpGRmkrbHFOc2lKK29RQThXMUVncGFZYzlXcW9YL0phdTRucFY4N1JqVWpKUVJLDQpKNmlOVUNXUXJnaTNUOWtVTTd2R3YxQzU2MWtDQXdFQUFhTTdNRGt3TndZRFZSMFJCREF3TG9Jc2NHVndjaTF2DQpZbXBsWTNRdGMzUnZjbUZuWlMxdmNHVnlZWFJ2Y2k1d1pYQnlMWE41YzNSbGJTNXpkbU13RFFZSktvWklodmNODQpBUUVMQlFBRGdnRUJBS21EREhhVmdyS3RRenZlVC9EZHlHWXBEK04zZ2EyUzM3NkEzM3hMTWZrYmw0cWZOWEFFDQpJeWw2Y3VHWm5GY2svRTkxNnRpUDNTOFdMTEFjUnpWK2NvU29UeWRaRFVZNkZWbEF6UUhnRU5MSEozUGcyK0xtDQpRNE81eCtTSVVpTGJpd0c4dkJuUnk0NEtaMzV4ZHNjSG15YmlNRFZtYk90WjVPejliTFZDcjBCeGpDRFpGWlFjDQp4TGVaQm0rUFduN0NudVVEby85SnJRRCtYQmZzZlZhTWlNbzFoSlZqRHowTUhsQXZES3ZReituc3hTNWRVU2NNDQpSYnZDZTFrR2xVMm1PSzl2RWZZc3VHT3k2eHAycmY3QS9qU3VHZktEcGs2aUJZVXE5Wm5rL1kreW44WnF3Rk5yDQpwRW1tWnFNK0VRR1FVRzRCMXNXNjlEbE1DQ2NYSmpZT0Nkdz0NCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0NCg==
  tls.key: >-
    LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQ0KTUlJRW9nSUJBQUtDQVFFQWxnTEhvVmxMR1ZlUWlibkZOd0Z1NE5ZblNHTHE2czk2emRIdzYyQ0g3cTU0dTdxag0KVkM4QjNnTkx5V0xNSmtqQ1h2WG16dFRyZ2xuZlFNRTVBdWQvdzRZa3UwNkJQTjdnaTU3eG1tOUxGVlJ5U05RVA0KZ1BXU2piVWs5cHpBNmJ3S2xZVXpGcGRLdEdVNTNITzR3b1c4U0hPbUdYbk1wVzRkbXVSakUwTU0vdGRwcEoxYg0KaFdFTmhpUGJzYVJ2R2l6MVErcmZKSitQdEp0ekJvc05OTStIZkpIQ0drdER2dnRLK2MyNmVUWkFiays0MGwzdg0Kd2xWZHhldDhURDkzMDZuMmtaSVVlNVlKRVcxU01VV0w2V28yeUluNmhBRHhiVVNDbHBoejFhcWhmOGxxN2llbA0KWHp0R05TTWxCRW9ucUkxUUpaQ3VDTGRQMlJRenU4YS9VTG5yV1FJREFRQUJBb0lCQUJablZtQzB5UWhCSVdOTQ0KVlJXY3QyNUpWWWNVVE9EaU9VVTlia1Y4L25ncFl2c29pZVdUK3F1cFl0dHlENnJGRVpCa21jSzRubTZ5bE9yag0KSUt4Y0hpTDVxUWszVllwZGYvd2lNaE9lUFFDendyaTVRYXR3SWFIYjFLZ25LNUdNNWFqRWdxZUVVMklqUHhPNw0KVGJQeGpMZm1XNzl3eHgxSzE0MlBQL083dnhoZElZeDNacjhYRnJud2phTmo3dFlVYWdKZHJmZE9xOUhrN28zMg0KNDh3d29SQnhzbkFzVjBCK29iUjZFUDZMdzhBNEhNLyswQXlzUU1kZjNISVMzVHVYS3BTTUN5V3hPUkVUNXZlUA0KZmlWcHNteEUrMnQyOVo5U0UwVHA2a01iSTdqY2djdXNrbWl1RVNnRVhQWWZ0VDk0YzlpMy9DS3BWMFlxL1JvQw0KSmJiN0xYMENnWUVBeDlBZEVVS0psK0Jxd0ZhNjhsM2JYQkM5ODJ0SzhXeHh5TENnLytaNXBvQUNTTkZtU1FNZw0KZU1nVGl1QWVKY0F5Tyt4Qm9UcjF2ODZTcWwybFNFcUtiSCs1N3ZsSmRMaW81dXhqdmJ6aFNacndxeURNczNSZA0KdllUMm90TEViMW1ITk1QdEhnVnd3aFhPL0pMQjdQZVBEb2dtNnZPYTRhNWtpWlRzWFdEVkMwVUNnWUVBd0RHVA0KVlAzUTVKTzltbjhxOHBqT2ZLYVpoeU5kenZsNWx4MUIxQXpncWhySVRJUmUyRUNuYlhMR1NqdnQ1dFAzR3JrRQ0KRGFBTXJIK2pReVZ5cy9rd0F6cFNuT2FxbGwyc0V1NVpTOWhwTkYrUWNFVy8vL043YnV1d2NoWlVHUWNFVVYvbw0Kc3o3ZGIrVk5sSjF0MnV0dWZpalp3WEdtQ01OVmRINmNNV0J2bHdVQ2dZQUpySXpMdWlINVJYZEZxcTFRY0xUZg0KSnp4YkhiVzZMSnJ4c1lPS0FEbWhrdzhKUVlJblJNeDhySXN0clI0b2k3Nmk0aFJuWHZobytmSmw1elRLWkRtQg0KZVVtaVJWV0dIaTZuUjRpb3RnMWVSKzhoQ2V4L1A4SU9HL0xvL1RWZmdzRW1EOXBhR3I5VDFrUjRQQTdCajFiUQ0KeUV6Q0VWdE5VK2t3TkJLaGpyK2gxUUtCZ0MyR2tNTzlLOUk1UE54djZ4aDBJZFZkRVZqMWc2OFhZVG51Y0QxdQ0KbjNrcnh1NTVISTVWSWxQR3NEbTlZR2toSkpOcjZBM2lMNTVjemF1R0gxbUtXVmtxWTQ5UEJIR0IxdFRWS01uUw0KaFhrbWVleGVXVkNqdUVWYUJ2Mi9WRVJwYVJodGc0MlNBcG9TMHdHMUdPU1dpQ0hTUTJLVExTVStQK3ZNWWV0QQ0KVUs2UkFvR0FUTE9QRm1GWC94cytKU05GZGlnU1VKdGdxR3JxbjFUSE5NZk1Ldm9hUVpoMmVCSnMvckRBem9RSA0KVld3dHJTVzlYdTJhSkZQUkVyNVF3N0tjV3BqdHNhc2lCbU9LNmNRYnJRTUh1cE43ZXZONzQzd05FL0hKcHMzZQ0KaFQ2TWFuV3VybzlBb1VML01sY2lPL0tRSUFZSHFCSW5mMUNGalJ3UVp3RC9MWThHeEY4PQ0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0NCg==
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pepr-object-storage-operator
  namespace: pepr-system
  labels:
    app: pepr-object-storage-operator
    pepr.dev/controller: admission
spec:
  replicas: 2
  selector:
    matchLabels:
      app: pepr-object-storage-operator
      pepr.dev/controller: admission
  template:
    metadata:
      annotations:
        buildTimestamp: '1706219617857'
      labels:
        app: pepr-object-storage-operator
        pepr.dev/controller: admission
    spec:
      priorityClassName: system-node-critical
      serviceAccountName: pepr-object-storage-operator
      securityContext:
        runAsUser: 65532
        runAsGroup: 65532
        runAsNonRoot: true
        fsGroup: 65532
      containers:
        - name: server
          image: ghcr.io/defenseunicorns/pepr/controller:v0.23.1
          imagePullPolicy: IfNotPresent
          command:
            - node
            - /app/node_modules/pepr/dist/controller.js
            - fda3ee3d27f1c354af02d4b43758930345458858db9ecd4de19681b0130bee6a
          readinessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
          livenessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
          ports:
            - containerPort: 3000
          resources:
            requests:
              memory: 64Mi
              cpu: 100m
            limits:
              memory: 256Mi
              cpu: 500m
          env:
            - name: PEPR_WATCH_MODE
              value: 'false'
            - name: PEPR_PRETTY_LOG
              value: 'false'
            - name: LOG_LEVEL
              value: debug
          securityContext:
            runAsUser: 65532
            runAsGroup: 65532
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tls-certs
              mountPath: /etc/certs
              readOnly: true
            - name: api-token
              mountPath: /app/api-token
              readOnly: true
            - name: module
              mountPath: /app/load
              readOnly: true
      volumes:
        - name: tls-certs
          secret:
            secretName: pepr-object-storage-operator-tls
        - name: api-token
          secret:
            secretName: pepr-object-storage-operator-api-token
        - name: module
          secret:
            secretName: pepr-object-storage-operator-module
---
apiVersion: v1
kind: Service
metadata:
  name: pepr-object-storage-operator
  namespace: pepr-system
  labels:
    pepr.dev/controller: admission
spec:
  selector:
    app: pepr-object-storage-operator
    pepr.dev/controller: admission
  ports:
    - port: 443
      targetPort: 3000
---
apiVersion: v1
kind: Service
metadata:
  name: pepr-object-storage-operator-watcher
  namespace: pepr-system
  labels:
    pepr.dev/controller: watcher
spec:
  selector:
    app: pepr-object-storage-operator-watcher
    pepr.dev/controller: watcher
  ports:
    - port: 443
      targetPort: 3000
---
apiVersion: v1
kind: Secret
metadata:
  name: pepr-object-storage-operator-module
  namespace: pepr-system
type: Opaque
data:
  module-fda3ee3d27f1c354af02d4b43758930345458858db9ecd4de19681b0130bee6a.js.gz: >-
    H4sIAAAAAAAAE61U227cNhB9z1ewbJGVAIpeZxEg4EJG2/QCI00cpAjyYBgIlxzLzHJJdkjKEQT9e0Bp027QXF7yxpkzN505o14i6dqr3TtQiWu4NQ5eog+Aadj2EolvK2BYtxddBYw6eQDKxl7aDAKZ8u7WdBnlzoL4YT3Vc4ppEf7JBqGiAQLSxRvasWQL6udeTUweZQdN6SWTR8p6wGi8E3TN1/ycMg1RoQlp9v1CnuUdoIMEkVwdc8itR3KQTnbGdWQpTI6FyS6rPaTIKdvDcO9RR3G9DMTo/kmkjAZvjRoacJ1xUGwI2By8zrZYEVRGkwZ6w5aIKEbnNQh60Z4/4Wu+phMrKeJbH5az0V+Bvfsd0aOgCCWCMmnv5RAvO+cRluIxSAVRXN8wK3dgy2tiximbNeg/jF0wcL0Yp4kttEUx7rKxWlAX3pMyKJlt8vAhUYFoE9PZyRc3X5iPD/JgC8nmFmKKZ4W9jW4ipByoKG+ibI4JkGiwkGBu1WjoS6NTWCHIU7hp9pvYSOzIqmk07HL3cwTsAcV6RZrmXpo0l8g7UMkS9Nb6XPYrU45EQ7B+OIBLpHFzUBOHmOBAJ6YhgNPglClLm3dE1/zRhp/PYP/bJ3gawlFpgj7mG76h0zRLVn5WyOqz3tQqK2Mk8D6B05EoLvmf4ACNemacHsvURo2+SncmMvr35tdZnrSeYgC19ItLjf/H0nqScXDqSOGSWmE9Wkjk0CIvNXgRCtMfLYTOeLdV3kVvgVvfVW+flvRyKsttkNVP42FaEePIEl0celq9rY8EuNbBPZH8qQxyZ6xJQ/UtrX+3oz2VPT3C9Gaq2fjmDpywU+u21ZpJ/go6U/RVaK6rxMYOfQ6CahnvtBwi19Cf/Fz6c8r2xmnx3w6memurVPPLOBME+gpfB10eVc0v3YuPk1T/zlHzNzKpu2rZCrQXo5zlWuiKVc0/2RPUU70tiOEvIeDz+dyqwK7dTb19cHb2I4k+o4LnMgTjutev/mrnG/nSQb6L/CDDgw+7vuOQugUAAA==
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: peprstores.pepr.dev
spec:
  group: pepr.dev
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            data:
              type: object
              additionalProperties:
                type: string
  scope: Namespaced
  names:
    plural: peprstores
    singular: peprstore
    kind: PeprStore
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pepr-object-storage-operator-store
  namespace: pepr-system
rules:
  - apiGroups:
      - pepr.dev
    resources:
      - peprstores
    resourceNames:
      - ''
    verbs:
      - create
      - get
      - patch
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pepr-object-storage-operator-store
  namespace: pepr-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: pepr-object-storage-operator-store
subjects:
  - kind: ServiceAccount
    name: pepr-object-storage-operator-store
    namespace: pepr-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pepr-object-storage-operator-watcher
  namespace: pepr-system
  labels:
    app: pepr-object-storage-operator-watcher
    pepr.dev/controller: watcher
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: pepr-object-storage-operator-watcher
      pepr.dev/controller: watcher
  template:
    metadata:
      annotations:
        buildTimestamp: '1706219617856'
      labels:
        app: pepr-object-storage-operator-watcher
        pepr.dev/controller: watcher
    spec:
      serviceAccountName: pepr-object-storage-operator
      securityContext:
        runAsUser: 65532
        runAsGroup: 65532
        runAsNonRoot: true
        fsGroup: 65532
      containers:
        - name: watcher
          image: ghcr.io/defenseunicorns/pepr/controller:v0.23.1
          imagePullPolicy: IfNotPresent
          command:
            - node
            - /app/node_modules/pepr/dist/controller.js
            - fda3ee3d27f1c354af02d4b43758930345458858db9ecd4de19681b0130bee6a
          readinessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
          livenessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
          ports:
            - containerPort: 3000
          resources:
            requests:
              memory: 64Mi
              cpu: 100m
            limits:
              memory: 256Mi
              cpu: 500m
          securityContext:
            runAsUser: 65532
            runAsGroup: 65532
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tls-certs
              mountPath: /etc/certs
              readOnly: true
            - name: module
              mountPath: /app/load
              readOnly: true
          env:
            - name: PEPR_WATCH_MODE
              value: 'true'
            - name: PEPR_PRETTY_LOG
              value: 'false'
            - name: LOG_LEVEL
              value: debug
      volumes:
        - name: tls-certs
          secret:
            secretName: pepr-object-storage-operator-tls
        - name: module
          secret:
            secretName: pepr-object-storage-operator-module
